<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEM YURAN & INVENTORI PRASEKOLAH LAVENDER 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF & Excel Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        brand: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95' }
                    }
                }
            }
        }
    </script>

    <!-- CSS Khas untuk Cetakan -->
    <style>
        @media print {
            .no-print, .no-print * { display: none !important; }
            body { background-color: white; -webkit-print-color-adjust: exact; }
            #receiptView { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0; background-color: white; z-index: 9999; }
            #receiptContent { box-shadow: none !important; border: none !important; margin: 0 !important; padding: 0 !important; width: 100% !important; }
        }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #6d28d9; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Disabled button style */
        .btn-disabled { opacity: 0.6; cursor: not-allowed; background-color: #94a3b8 !important; pointer-events: none; }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, query, doc, updateDoc, where, getDocs, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD-A55Mn0L1R6jgbtqpNBJbhcuB5LRs9_g",
            authDomain: "eshop-50e45.firebaseapp.com",
            projectId: "eshop-50e45",
            storageBucket: "eshop-50e45.firebasestorage.app",
            messagingSenderId: "71035382592",
            appId: "1:71035382592:web:71483077d43bf76125e8a5",
            measurementId: "G-3EEH8B12NL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- MENGGUNAKAN ROOT COLLECTIONS ---
        const itemsColl = collection(db, 'book_items');
        const ordersColl = collection(db, 'book_orders');
        const configDocRef = doc(db, 'book_config', 'general');

        console.log("Sistem beroperasi. Telegram Module Active (Root Paths).");

        // Global State
        window.itemsA = [];
        window.itemsB = [];
        window.orders = [];
        window.currentReceipt = null;
        window.cartState = {}; 
        window.chartP = null;
        window.selectedOrderIdForPayment = null;
        window.isAdminUser = false;
        window.editingOrderId = null; // New state for editing
        window.appConfig = { telegramBotToken: '', telegramChatId: '' };
        window.isSystemOpen = true; // Default open until fetch

        // --- HELPER UNTUK KIRA KOS ---
        window.calculateSpecificItemCost = (order, keywordStr, excludeStr = null) => {
            let total = 0;
            const keywords = keywordStr.split(',');
            const excludes = excludeStr ? excludeStr.split(',') : [];
            const allItems = [...window.itemsA, ...window.itemsB];
            if(order.items) {
                Object.entries(order.items).forEach(([itemId, qty]) => {
                    const item = allItems.find(i => i.id === itemId);
                    if(item) {
                        const name = item.name.toUpperCase();
                        const matchesKeyword = keywords.some(k => name.includes(k.trim().toUpperCase()));
                        const matchesExclude = excludes.length > 0 && excludes.some(e => name.includes(e.trim().toUpperCase()));
                        if(matchesKeyword && !matchesExclude) total += (item.price * qty);
                    }
                });
            }
            return total;
        };

        window.isNametagItem = (name) => {
            if(!name) return false;
            const n = name.toUpperCase();
            return n.includes('NAMETAG') || n.includes('TAG NAMA');
        };

        // --- TELEGRAM NOTIFICATION FUNCTION ---
        window.sendTelegramNotification = async (orderData) => {
            try {
                const snap = await getDoc(configDocRef);
                let token = '';
                let chatId = '';

                if (snap.exists()) {
                    const data = snap.data();
                    token = data.telegramBotToken;
                    chatId = data.telegramChatId;
                }

                if (token && chatId) {
                    const msg = `<b>TEMPAHAN ${window.editingOrderId ? 'DIKEMASKINI' : 'BARU'} üìù</b>\n\n` +
                                `<b>Nama Murid:</b> ${orderData.name}\n` +
                                `<b>Ibu Bapa:</b> ${orderData.parent}\n` +
                                `<b>No. Tel:</b> ${orderData.phone}\n` +
                                `<b>Jumlah:</b> RM ${orderData.total.toFixed(2)}\n` +
                                `<b>ID Tempahan:</b> <code>${orderData.id ? orderData.id.substring(0,8).toUpperCase() : '-'}</code>\n\n` +
                                `<i>Sila semak sistem admin untuk tindakan lanjut.</i>`;
                    
                    const url = `https://api.telegram.org/bot${token}/sendMessage`;
                    await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: msg,
                            parse_mode: 'HTML'
                        })
                    });
                    console.log("Telegram notification sent.");
                } else {
                    console.log("Telegram config missing. Skipping notification.");
                }
            } catch (e) {
                console.error("Telegram API Error:", e);
            }
        };

        // --- SYSTEM STATUS LOGIC ---
        window.updateSystemUI = () => {
            // Update Admin Button
            const btn = document.getElementById('btnToggleSystem');
            if(btn) {
                if(window.isSystemOpen) {
                    btn.innerText = "DIBUKA (ON)";
                    btn.className = "px-6 py-2 rounded-lg font-bold text-xs text-white transition shadow-lg bg-green-500 hover:bg-green-600";
                } else {
                    btn.innerText = "DITUTUP (OFF)";
                    btn.className = "px-6 py-2 rounded-lg font-bold text-xs text-white transition shadow-lg bg-red-500 hover:bg-red-600";
                }
            }
            
            // Update Landing Page Button
            const landingBtn = document.getElementById('landingStartBtn');
            const landingMsg = document.getElementById('landingStatusMsg');
            if(landingBtn) {
                if(window.isSystemOpen) {
                     landingBtn.innerHTML = 'MULA SEKARANG <i class="fas fa-arrow-right ml-2"></i>';
                     landingBtn.classList.remove('btn-disabled');
                     landingBtn.onclick = window.startOrder;
                     if(landingMsg) landingMsg.classList.add('hidden');
                } else {
                     landingBtn.innerHTML = 'TEMPAHAN DITUTUP <i class="fas fa-lock ml-2"></i>';
                     landingBtn.classList.add('btn-disabled');
                     landingBtn.onclick = null;
                     if(landingMsg) landingMsg.classList.remove('hidden');
                }
            }
        };

        window.toggleSystemStatus = async () => {
            const newState = !window.isSystemOpen;
            try {
                await setDoc(configDocRef, { isSystemOpen: newState }, { merge: true });
            } catch(e) { alert("Gagal kemaskini status: " + e.message); }
        };

        // --- NAVIGATION ---
        window.goHome = () => {
            ['user-view', 'check-view', 'admin-view', 'receiptView'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('landing-view').classList.remove('hidden');
            document.getElementById('mainNavbar').classList.remove('hidden');
            document.getElementById('mobileActionBar').classList.add('hidden');
            
            // Reset states
            window.editingOrderId = null;
            window.cartState = {};
            document.getElementById('studentName').value = '';
            document.getElementById('parentName').value = '';
            document.getElementById('parentPhone').value = '';
            window.updateSystemUI(); // Ensure UI is correct on home load
        };

        window.startOrder = () => {
            if(!window.isSystemOpen) {
                alert("Maaf, sistem tempahan telah ditutup oleh pihak pentadbiran.");
                return;
            }
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('user-view').classList.remove('hidden');
            window.safeNavigate('section-info');
            document.getElementById('mobileActionBar').classList.remove('hidden');
            // Ensure form is fresh if not editing
            if(!window.editingOrderId) {
                window.renderUserForm(); // Reset inputs
            }
        };

        window.startCheck = () => {
            document.getElementById('landing-view').classList.add('hidden');
            document.getElementById('check-view').classList.remove('hidden');
        };

        window.safeNavigate = (id) => {
            ['section-info', 'section-a', 'section-b', 'section-d'].forEach(sid => document.getElementById(sid).classList.add('hidden'));
            const target = document.getElementById(id);
            if(target) {
                target.classList.remove('hidden');
                target.classList.add('animate-fadeUp');
            }
            window.scrollTo({top: 0, behavior: 'smooth'});
            if(id === 'section-d') window.renderSummary();
            
            const steps = ['info', 'a', 'b', 'd'];
            const activeIdx = {'section-info':0, 'section-a':1, 'section-b':2, 'section-d':3}[id];
            const pb = document.getElementById('progress-bar-fill');
            if(pb) pb.style.width = `${(activeIdx / 3) * 100}%`;
            
            steps.forEach((key, idx) => {
                const circle = document.querySelector(`#step-${key} .step-circle`);
                const label = document.querySelector(`#step-${key} .step-label`);
                if(idx <= activeIdx) {
                    circle.classList.remove('bg-white', 'text-slate-300');
                    circle.classList.add('bg-brand-600', 'text-white', 'border-brand-600');
                    label.classList.add('text-brand-700');
                } else {
                    circle.classList.add('bg-white', 'text-slate-300');
                    circle.classList.remove('bg-brand-600', 'text-white', 'border-brand-600');
                    label.classList.remove('text-brand-700');
                }
            });
        };

        window.nextSection = (targetId) => {
            if(targetId === 'section-a') {
                if(!document.getElementById('studentName').value || !document.getElementById('parentName').value || !document.getElementById('parentPhone').value) {
                    alert("Sila lengkapkan semua butiran."); return;
                }
            }
            window.safeNavigate(targetId);
        };

        // --- ORDER LOGIC ---
        window.calcAll = () => {
            const totalAEl = document.getElementById('totalA');
            if (!totalAEl) return;
            let total = parseFloat(totalAEl.innerText) || 0;
            window.cartState = {};
            
            document.querySelectorAll('.qty-input').forEach(inp => {
                const qty = parseInt(inp.value) || 0;
                const price = parseFloat(inp.dataset.price);
                const id = inp.dataset.id;
                
                if (qty > 0) {
                    window.cartState[id] = qty;
                    total += (qty * price);
                    document.getElementById(`tagInput-${id}`)?.classList.remove('hidden');
                } else {
                    document.getElementById(`tagInput-${id}`)?.classList.add('hidden');
                }
                
                const subEl = document.getElementById(`sub-${id}`);
                if(subEl) subEl.innerText = (qty * price).toFixed(2);
            });
            
            const totalStr = `RM ${total.toFixed(2)}`;
            if(document.getElementById('grandTotalDisplay')) document.getElementById('grandTotalDisplay').innerText = totalStr;
            if(document.getElementById('mobileGrandTotal')) document.getElementById('mobileGrandTotal').innerText = totalStr;
        };

        window.updateCharCount = (input) => {
            const max = 12;
            const current = input.value.length;
            const counterId = input.id.replace('tagNameInput-', 'charCount-');
            const counter = document.getElementById(counterId);
            if(counter) {
                counter.innerText = `${current}/${max}`;
                if(current >= max) counter.classList.add('text-red-500');
                else counter.classList.remove('text-red-500');
            }
        };

        window.renderUserForm = () => {
            const tA = document.getElementById('tbody-a');
            const tB = document.getElementById('tbody-b');
            const totalAEl = document.getElementById('totalA');
            
            // Render Items A (WAJIB - FIXED 1 UNIT)
            if(window.itemsA.length) {
                tA.innerHTML = window.itemsA.map((i, idx) => {
                    const currentQty = window.cartState[i.id] || 0;
                    // FIX: Check nametag status for Item A too!
                    const isTag = i.isNametag || window.isNametagItem(i.name);
                    
                    return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                        <td class="p-4">
                            <div class="flex flex-col">
                                <div class="flex items-center">
                                    <span class="text-xs font-bold text-slate-400 mr-2">${idx + 1}.</span>
                                    <span class="font-medium text-slate-700 uppercase">${i.name}</span>
                                </div>
                                ${isTag ? `
                                    <div id="tagInput-${i.id}" class="mt-3 bg-blue-50 p-3 rounded-lg border border-blue-100 animate-fadeUp">
                                        <label class="text-[10px] font-bold text-blue-600 uppercase mb-1 block">Nama Pada Tag (Wajib)</label>
                                        <input type="text" id="tagNameInput-${i.id}" maxlength="12" oninput="window.updateCharCount(this)" class="w-full border border-blue-200 p-2 text-sm rounded uppercase font-bold text-slate-700 focus:outline-none focus:border-blue-500" placeholder="ALI BIN ABU">
                                        <div class="flex justify-between mt-1">
                                            <span class="text-[9px] text-blue-400">* Termasuk jarak</span>
                                            <span id="charCount-${i.id}" class="text-[9px] font-bold text-slate-400">0/12</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                        <td class="p-4 text-center text-sm text-slate-500">RM ${i.price.toFixed(2)}</td>
                        <td class="p-4 text-center">
                             <input type="hidden" value="1" data-id="${i.id}" data-price="${i.price}" class="qty-input" onchange="window.calcAll()">
                             <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-bold border border-gray-200 cursor-not-allowed">1 Unit (Wajib)</span>
                        </td>
                        <td class="p-4 text-right font-bold text-slate-700" id="sub-${i.id}">RM ${i.price.toFixed(2)}</td>
                    </tr>`
                }).join('');
            } else tA.innerHTML = '<tr><td colspan="4" class="p-6 text-center italic text-slate-400">Tiada item wajib.</td></tr>';
            
            // Render Items B (PILIHAN - EDITABLE)
            if(window.itemsB.length) {
                tB.innerHTML = window.itemsB.map(i => {
                    const isTag = i.isNametag || window.isNametagItem(i.name);
                    const currentQty = window.cartState[i.id] || 0;
                    return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                        <td class="p-4">
                            <div class="font-medium text-slate-700 uppercase">${i.name}</div>
                            ${isTag ? `
                                <div id="tagInput-${i.id}" class="${currentQty > 0 ? '' : 'hidden'} mt-3 bg-blue-50 p-3 rounded-lg border border-blue-100 animate-fadeUp">
                                    <label class="text-[10px] font-bold text-blue-600 uppercase mb-1 block">Nama Pada Tag (Wajib)</label>
                                    <input type="text" id="tagNameInput-${i.id}" maxlength="12" oninput="window.updateCharCount(this)" class="w-full border border-blue-200 p-2 text-sm rounded uppercase font-bold text-slate-700 focus:outline-none focus:border-blue-500" placeholder="ALI BIN ABU">
                                    <div class="flex justify-between mt-1">
                                        <span class="text-[9px] text-blue-400">* Termasuk jarak</span>
                                        <span id="charCount-${i.id}" class="text-[9px] font-bold text-slate-400">0/12</span>
                                    </div>
                                </div>
                            ` : ''}
                        </td>
                        <td class="p-4 text-center text-sm text-slate-500">RM ${i.price.toFixed(2)}</td>
                        <td class="p-4 text-center">
                            <div class="inline-flex border rounded bg-white">
                                <button onclick="this.nextElementSibling.stepDown();this.nextElementSibling.onchange()" class="px-2 text-slate-400 hover:text-brand-600">-</button>
                                <input type="number" min="0" value="${currentQty}" data-id="${i.id}" data-price="${i.price}" class="qty-input w-10 text-center border-x py-1 text-sm outline-none" onchange="window.calcAll()" oninput="window.calcAll()">
                                <button onclick="this.previousElementSibling.stepUp();this.previousElementSibling.onchange()" class="px-2 text-slate-400 hover:text-brand-600">+</button>
                            </div>
                        </td>
                        <td class="p-4 text-right font-bold text-slate-700" id="sub-${i.id}">0.00</td>
                    </tr>`;
                }).join('');
            } else tB.innerHTML = '<tr><td colspan="4" class="p-6 text-center italic text-slate-400">Tiada item pilihan.</td></tr>';
            
            setTimeout(window.calcAll, 100);
        };

        window.renderSummary = () => {
            const tbody = document.getElementById('summary-tbody');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            if (window.itemsA.length > 0) {
                tbody.innerHTML += `<tr><td colspan="3" class="bg-slate-50 p-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Item Wajib</td></tr>`;
                window.itemsA.forEach(i => { 
                    const qty = window.cartState[i.id] || 1; // Default to 1 if missing for A
                    let meta = '';
                    if(i.isNametag || window.isNametagItem(i.name)) {
                         const val = document.getElementById(`tagNameInput-${i.id}`)?.value.toUpperCase() || 'TIADA NAMA';
                         meta = `<div class="text-[10px] text-purple-600 font-bold bg-purple-50 inline-block px-2 py-0.5 rounded border border-purple-100 mt-1"><i class="fas fa-tag mr-1"></i> ${val}</div>`;
                    }
                    tbody.innerHTML += `<tr class="border-b border-slate-50 text-sm"><td class="py-2 pl-2 uppercase"><div>${i.name}</div>${meta}</td><td class="py-2 text-center">${qty}</td><td class="py-2 pr-2 text-right font-medium">RM ${(i.price * qty).toFixed(2)}</td></tr>`; 
                });
            }
            
            const selectedItemsB = window.itemsB.filter(i => window.cartState[i.id] > 0);
            if(selectedItemsB.length > 0) {
                tbody.innerHTML += `<tr><td colspan="3" class="bg-slate-50 p-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-2">Item Pilihan</td></tr>`;
                selectedItemsB.forEach(item => {
                    const qty = window.cartState[item.id];
                    let meta = '';
                    if(item.isNametag || window.isNametagItem(item.name)) {
                        const val = document.getElementById(`tagNameInput-${item.id}`)?.value.toUpperCase() || 'TIADA NAMA';
                        meta = `<div class="text-[10px] text-purple-600 font-bold bg-purple-50 inline-block px-2 py-0.5 rounded border border-purple-100 mt-1"><i class="fas fa-tag mr-1"></i> ${val}</div>`;
                    }
                    tbody.innerHTML += `<tr class="border-b border-slate-50 text-sm"><td class="py-2 pl-2"><div class="uppercase">${item.name}</div>${meta}</td><td class="py-2 text-center">${qty}</td><td class="py-2 pr-2 text-right font-medium">RM ${(item.price * qty).toFixed(2)}</td></tr>`;
                });
            }
        };

        window.submitOrder = async () => {
            const btn = document.querySelector('button[onclick="window.submitOrder()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loader mr-2"></span> PROSES...';
            btn.disabled = true;

            if(!window.isSystemOpen) {
                 alert("Maaf, tempahan telah ditutup.");
                 btn.innerHTML = originalText; btn.disabled = false; return;
            }

            if (!auth.currentUser) {
                try { await signInAnonymously(auth); } 
                catch (authError) { btn.innerHTML = originalText; btn.disabled = false; alert("Ralat Sistem: " + authError.message); return; }
            }

            const name = document.getElementById('studentName').value.toUpperCase();
            const parent = document.getElementById('parentName').value.toUpperCase();
            const phone = document.getElementById('parentPhone').value;
            const total = parseFloat(document.getElementById('grandTotalDisplay').innerText.replace('RM ', ''));
            
            if(!name || !parent || !phone) { 
                btn.innerHTML = originalText; btn.disabled = false; alert("Sila isi semua maklumat."); return; 
            }

            let items = {};
            // Gather all items from cartState (Includes A which has quantity 1 by default logic if displayed)
            // But we must iterate all available items because calcAll might not have run for hidden inputs
            
            // Re-verify quantities
            [...window.itemsA, ...window.itemsB].forEach(i => {
                const inp = document.querySelector(`.qty-input[data-id="${i.id}"]`);
                if(inp) {
                    const q = parseInt(inp.value) || 0;
                    if(q > 0) items[i.id] = q;
                } else if (window.itemsA.find(a => a.id === i.id)) {
                    // Force Include Item A if input missing (it should be there though)
                    items[i.id] = 1;
                }
            });

            // FIX: Check ALL items for nametag requirement
            const allItems = [...window.itemsA, ...window.itemsB];
            const tagItems = allItems.filter(i => i.isNametag || window.isNametagItem(i.name));
            let tagName = "";

            for(let t of tagItems) {
                if(items[t.id]) {
                    // It's in the order
                    const inputEl = document.getElementById(`tagNameInput-${t.id}`);
                    if(inputEl) {
                        tagName = inputEl.value.toUpperCase().trim();
                        if(!tagName) { btn.innerHTML = originalText; btn.disabled = false; alert("Sila isi NAMA PADA TAG untuk " + t.name); return; }
                        if(tagName.length > 12) { btn.innerHTML = originalText; btn.disabled = false; alert("Nama tag max 12 huruf."); return; }
                        // Stop after finding first nametag? Or allow multiple? 
                        // Current logic assumes 1 nametag per student usually. 
                        // If multiple nametags, this logic overwrites 'tagName'. 
                        // Ideally store tagName in items object but structure is flattened.
                        // For now, keep as is (single tagName field).
                        break; 
                    }
                }
            }
            
            let orderData = { 
                name, parent, phone, total, items, tagName,
                timestamp: Date.now()
            };

            try {
                let ref;
                if (window.editingOrderId) {
                    ref = doc(db, 'book_orders', window.editingOrderId);
                    await updateDoc(ref, orderData);
                    const snap = await getDoc(ref);
                    orderData = { id: snap.id, ...snap.data() };
                    alert("Tempahan berjaya dikemaskini.");
                    await window.sendTelegramNotification(orderData); 
                } else {
                    orderData.date = new Date().toLocaleDateString('ms-MY');
                    orderData.paid = 0;
                    orderData.tagStatus = false;
                    orderData.paymentLogs = [];
                    orderData.adminVerified = false;
                    ref = await addDoc(ordersColl, orderData);
                    orderData.id = ref.id;
                    await window.sendTelegramNotification(orderData); 
                }
                
                window.currentReceipt = orderData;
                window.renderReceiptView(window.currentReceipt);
                window.editingOrderId = null; 
            } catch(e) { 
                console.error(e);
                alert("Gagal menghantar tempahan! Ralat: " + e.message); 
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        // --- ADMIN VERIFY ORDER ---
        window.verifyOrder = async (id) => {
             if(confirm("Adakah anda pasti ingin mengesahkan tempahan ini?\nIbu bapa tidak akan dapat mengemaskini tempahan selepas ini.")) {
                 try {
                     await updateDoc(doc(db, 'book_orders', id), { adminVerified: true });
                 } catch(e) { alert("Ralat: " + e.message); }
             }
        };

        // --- EDIT ORDER LOGIC ---
        window.editOrder = (data) => {
            if ((data.paid || 0) > 0 || data.tagStatus === true || data.adminVerified === true) {
                alert("Maaf, tempahan ini telah disahkan oleh Admin dan tidak boleh diubah lagi. Sila hubungi pihak sekolah.");
                return;
            }

            if(confirm("Adakah anda ingin mengemaskini tempahan ini?")) {
                window.editingOrderId = data.id;
                document.getElementById('check-view').classList.add('hidden');
                document.getElementById('user-view').classList.remove('hidden');
                
                document.getElementById('studentName').value = data.name;
                document.getElementById('parentName').value = data.parent;
                document.getElementById('parentPhone').value = data.phone;
                
                window.cartState = data.items || {};
                
                window.renderUserForm();
                
                setTimeout(() => {
                    const allItems = [...window.itemsA, ...window.itemsB];
                    const tagItems = allItems.filter(i => i.isNametag || window.isNametagItem(i.name));
                    
                    for(let t of tagItems) {
                        if(window.cartState[t.id]) {
                            const inputEl = document.getElementById(`tagNameInput-${t.id}`);
                            if(inputEl && data.tagName) {
                                inputEl.value = data.tagName;
                                window.updateCharCount(inputEl);
                            }
                        }
                    }
                    window.calcAll(); 
                }, 500); // Increased timeout to ensure DOM ready

                window.safeNavigate('section-info');
            }
        };

        // --- CHECK STATUS ---
        window.doCheckStatus = async () => {
            const phone = document.getElementById('checkPhone').value.trim();
            const resDiv = document.getElementById('checkResults');
            if(!phone) { alert("Masukkan No. Telefon."); return; }
            resDiv.innerHTML = '<div class="text-center py-4"><span class="loader border-slate-300 border-t-blue-600"></span><p class="text-slate-400 text-xs mt-2">Sedang mencari...</p></div>';
            
            try {
                const q = query(ordersColl, where("phone", "==", phone));
                const snap = await getDocs(q);
                if(snap.empty) { resDiv.innerHTML = '<div class="text-center py-4 bg-slate-50 rounded">Tiada rekod dijumpai.</div>'; return; }
                
                let html = '<div class="space-y-3">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const baki = d.total - (d.paid || 0);
                    const statusClass = baki <= 0 ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700';
                    const isEditable = (d.paid || 0) === 0 && d.adminVerified !== true; 

                    const dataObj = {id: doc.id, ...d};
                    const dataStr = JSON.stringify(dataObj).replace(/"/g, '&quot;');
                    
                    html += `
                    <div class="bg-white p-4 rounded-xl border shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-slate-800 uppercase">${d.name}</h4>
                                <span class="text-xs font-bold px-2 py-1 rounded ${statusClass}">${baki <= 0 ? 'SELESAI' : 'TERTUNGGAK'}</span>
                                ${d.adminVerified ? '<span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold ml-1"><i class="fas fa-check-circle"></i> SAH</span>' : ''}
                            </div>
                            <p class="text-xs text-slate-500 mb-3 text-right">RM ${d.total.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='window.viewReceiptDirect(${dataStr})' class="flex-1 bg-brand-600 hover:bg-brand-700 text-white text-xs font-bold py-2 rounded-lg flex items-center justify-center gap-2"><i class="fas fa-file-invoice"></i> INVOIS</button>
                            ${isEditable ? `<button onclick='window.editOrder(${dataStr})' class="flex-1 bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold py-2 rounded-lg flex items-center justify-center gap-2"><i class="fas fa-edit"></i> KEMASKINI</button>` : ''}
                        </div>
                    </div>`;
                });
                resDiv.innerHTML = html + '</div>';
            } catch(e) { resDiv.innerHTML = 'Ralat sistem.'; console.error(e); }
        };

        window.viewReceiptDirect = (data) => window.renderReceiptView(data);
        window.viewReceiptFromAdmin = (id) => { const o = window.orders.find(x => x.id === id); if(o) window.renderReceiptView(o); };
        
        window.renderReceiptView = (data) => {
            ['landing-view', 'user-view', 'check-view', 'admin-view', 'mainNavbar'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('receiptView').classList.remove('hidden');
            
            document.getElementById('r-name').innerText = data.name;
            document.getElementById('r-parent').innerText = data.parent;
            document.getElementById('r-date').innerText = data.date;
            document.getElementById('r-id').innerText = data.id.substring(0,8).toUpperCase();
            
            const bal = data.total - (data.paid || 0);
            document.getElementById('doc-title').innerText = bal <= 0 ? "RESIT RASMI" : "INVOIS";
            
            const tb = document.getElementById('r-body');
            tb.innerHTML = '';
            
            // Note: If edit mode logic changes item structure, this handles display
            // We iterate A then B to show order
            
            window.itemsA.forEach(i => { 
                // Always check quantity in data.items just in case, but default 1 for A
                const q = data.items && data.items[i.id] ? data.items[i.id] : 1; 
                // FIX: Check if nametag
                const isTag = i.isNametag || window.isNametagItem(i.name);
                let n = i.name;
                if(isTag && data.tagName) n+=` (${data.tagName})`;

                tb.innerHTML += `<tr><td class="border-b py-2 uppercase">${n}</td><td class="border-b py-2 text-center">${i.price.toFixed(2)}</td><td class="border-b py-2 text-center">${q}</td><td class="border-b py-2 text-right">${(i.price*q).toFixed(2)}</td></tr>`; 
            });

            if(data.items) {
                Object.entries(data.items).forEach(([id, qty]) => {
                    const i = window.itemsB.find(x => x.id === id);
                    if(i) {
                        let n = i.name; 
                        if((i.isNametag || window.isNametagItem(i.name)) && data.tagName) n+=` (${data.tagName})`;
                        tb.innerHTML += `<tr><td class="border-b py-2 uppercase">${n}</td><td class="border-b py-2 text-center">${i.price.toFixed(2)}</td><td class="border-b py-2 text-center">${qty}</td><td class="border-b py-2 text-right">${(i.price*qty).toFixed(2)}</td></tr>`;
                    }
                });
            }
            document.getElementById('r-total').innerText = `RM ${data.total.toFixed(2)}`;
            document.getElementById('r-paid').innerText = `RM ${(data.paid||0).toFixed(2)}`;
            document.getElementById('r-balance').innerText = `RM ${bal.toFixed(2)}`;
            document.getElementById('r-balance-label').innerText = bal > 0 ? "BAKI PERLU DIBAYAR" : "BAKI SIFAR";
        };

        window.closeReceipt = () => {
            document.getElementById('receiptView').classList.add('hidden');
            if(window.isAdminUser) {
                document.getElementById('admin-view').classList.remove('hidden');
            } else if(document.getElementById('checkResults').innerHTML !== '') {
                document.getElementById('check-view').classList.remove('hidden');
                document.getElementById('mainNavbar').classList.remove('hidden');
            } else {
                window.goHome();
            }
        };

        window.printReceipt = () => window.print();

        // --- EXPORT FUNCTIONS ---
        window.generateCSV = (data, filename) => {
            const csvContent = "data:text/csv;charset=utf-8," + data.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", filename);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        window.exportPibgCsv = () => {
            const data = [["Nama Murid", "Nama Penjaga", "Bayaran (RM)", "Status"]];
            const pibgItems = [...window.itemsA, ...window.itemsB].filter(i => i.name.toUpperCase().includes('PIBG')).map(i => i.id);
            window.orders.forEach(o => {
                if(o.items && Object.keys(o.items).some(k => pibgItems.includes(k))) {
                     data.push([`"${o.name}"`, `"${o.parent}"`, o.paid.toFixed(2), (o.paid>=o.total ? "SELESAI" : "BELUM")]);
                }
            });
            window.generateCSV(data, "Laporan_PIBG.csv");
        };

        window.exportPibgPdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Laporan Yuran PIBG 2026", 14, 20);
            const pibgItems = [...window.itemsA, ...window.itemsB].filter(i => i.name.toUpperCase().includes('PIBG')).map(i => i.id);
            const body = window.orders
                .filter(o => o.items && Object.keys(o.items).some(k => pibgItems.includes(k)))
                .map(o => [o.name, o.parent, `RM ${o.paid.toFixed(2)}`, (o.paid >= o.total ? "SELESAI" : "BELUM")]);
            doc.autoTable({ head: [['Nama Murid', 'Penjaga', 'Bayaran', 'Status']], body: body, startY: 30 });
            doc.save("Laporan_PIBG.pdf");
        };
        
        window.exportNametagCsv = () => {
             const data = [["Nama Murid", "Teks Tag", "Kuantiti", "Status"]]; // Added Kuantiti header
             const tagItems = [...window.itemsA, ...window.itemsB].filter(i => i.isNametag || window.isNametagItem(i.name)).map(i => i.id);
             window.orders.forEach(o => {
                 if(o.items && Object.keys(o.items).some(k => tagItems.includes(k))) {
                     let qty = 0;
                     Object.keys(o.items).forEach(k => { if(tagItems.includes(k)) qty += o.items[k]; });
                     data.push([`"${o.name}"`, `"${o.tagName||'-'}"`, qty, o.tagStatus ? "SIAP" : "PROSES"]);
                 }
             });
             window.generateCSV(data, "Laporan_Nametag.csv");
        };

        window.exportNametagPdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Laporan Tempahan Nametag", 14, 20);
            const tagItems = [...window.itemsA, ...window.itemsB].filter(i => i.isNametag || window.isNametagItem(i.name)).map(i => i.id);
            const body = window.orders
                .filter(o => o.items && Object.keys(o.items).some(k => tagItems.includes(k)))
                .map(o => {
                    let qty = 0;
                    Object.keys(o.items).forEach(k => { if(tagItems.includes(k)) qty += o.items[k]; });
                    return [o.name, o.tagName || '-', qty, o.tagStatus ? "SIAP" : "PROSES"];
                });
            doc.autoTable({ head: [['Nama Murid', 'Teks Tag', 'Kuantiti', 'Status']], body: body, startY: 30 }); // Added Kuantiti header
            doc.save("Laporan_Nametag.pdf");
        };

        // --- ADMIN CORE ---
        window.switchView = (view) => {
             document.getElementById('landing-view').classList.add('hidden');
             const nav = document.getElementById('mainNavbar');
             if(view === 'admin') {
                 document.getElementById('user-view').classList.add('hidden');
                 document.getElementById('admin-view').classList.remove('hidden');
                 nav.classList.add('hidden');
                 window.setAdminTab('dash');
             } else window.goHome();
        };

        window.setAdminTab = (tab) => {
            document.querySelectorAll('.admin-tab').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.admin-nav-item').forEach(e => e.classList.remove('bg-slate-800', 'text-white'));
            document.getElementById(`adm-${tab}`)?.classList.remove('hidden');
            document.getElementById(`nav-${tab}`)?.classList.add('bg-slate-800', 'text-white');
            if(tab === 'dash') window.renderAdminDashboard();
            if(tab === 'orders') window.renderAdminOrders();
            if(tab === 'inventory') window.renderAdminInventory();
            if(tab === 'pibg') window.renderAdminPibg();
            if(tab === 'nametag') window.renderAdminNametags();
            if(tab === 'log') window.renderAdminLogs();
            if(tab === 'settings') window.renderAdminSettings();
        };

        window.renderAdminDashboard = () => {
             let rev=0, pend=0, tags=0;
             const tagItems = [...window.itemsA, ...window.itemsB].filter(i => i.isNametag || window.isNametagItem(i.name)).map(i => i.id);
             window.orders.forEach(o => { 
                 rev += (o.paid||0); 
                 if(o.total > (o.paid||0)) pend += (o.total - (o.paid||0)); 
                 if(o.items && Object.keys(o.items).some(k => tagItems.includes(k))) tags++;
             });
             document.getElementById('d-revenue').innerText = `RM ${rev.toFixed(2)}`;
             document.getElementById('d-count').innerText = window.orders.length;
             document.getElementById('d-pending').innerText = `RM ${pend.toFixed(2)}`;
             document.getElementById('d-tags').innerText = tags;
             
             const ctx = document.getElementById('chartPayment');
             if(ctx) {
                 if(window.chartP) window.chartP.destroy();
                 const full = window.orders.filter(o => (o.paid||0) >= o.total).length;
                 const none = window.orders.length - full;
                 window.chartP = new Chart(ctx.getContext('2d'), {
                     type: 'doughnut',
                     data: { labels: ['Selesai','Belum'], datasets: [{ data: [full, none], backgroundColor: ['#10b981','#ef4444'] }] },
                     options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position: 'bottom' } } }
                 });
             }
        };

        window.renderAdminOrders = () => {
            const tb = document.getElementById('adm-orders-body');
            if(!tb) return;
            tb.innerHTML = window.orders.sort((a,b)=> b.timestamp - a.timestamp).map(o => {
                const baki = o.total - (o.paid || 0);
                const isPaid = baki <= 0;
                // Check verification
                const isVerified = o.adminVerified === true;
                
                return `
                <tr class="border-b hover:bg-slate-50 text-sm">
                    <td class="p-3"><input type="checkbox" class="order-checkbox rounded border-slate-300" data-id="${o.id}"></td>
                    <td class="p-3"><div class="font-bold uppercase">${o.name}</div><div class="text-xs text-slate-500">${o.phone}</div></td>
                    <td class="p-3 text-center font-bold">RM ${o.total.toFixed(2)}</td>
                    <td class="p-3 text-center"><div class="text-xs font-bold ${o.paid>=o.total?'text-green-600':'text-red-600'}">${o.paid>=o.total?'LUNAS':'TUNGGAK'}</div><div class="text-xs text-slate-400">Bayar: RM ${(o.paid||0).toFixed(2)}</div></td>
                    <td class="p-3 text-center">
                        <button onclick="window.openPaymentModal('${o.id}', ${o.paid||0}, ${o.total})" class="text-brand-600 hover:bg-brand-50 p-1 rounded" title="Kemaskini Bayaran"><i class="fas fa-edit"></i></button>
                        <button onclick="window.viewReceiptFromAdmin('${o.id}')" class="text-blue-600 hover:bg-blue-50 p-1 rounded ml-1" title="Lihat Resit"><i class="fas fa-eye"></i></button>
                        ${!isVerified ? 
                            `<button onclick="window.verifyOrder('${o.id}')" class="text-green-600 hover:bg-green-50 p-1 rounded ml-1" title="Sahkan Tempahan"><i class="fas fa-check-circle"></i></button>` : 
                            `<span class="text-green-500 ml-1 cursor-help" title="Telah Disahkan"><i class="fas fa-lock"></i></span>`
                        }
                    </td>
                </tr>
            `}).join('');
        };

        window.renderAdminInventory = () => {
            const tb = document.getElementById('adm-inv-body');
            if(!tb) return;
            const all = [...window.itemsA, ...window.itemsB].sort((a,b)=>(a.order||0)-(b.order||0));
            tb.innerHTML = all.map(i => `
                <tr class="border-b hover:bg-slate-50 text-sm">
                    <td class="p-3"><input type="checkbox" class="inv-checkbox rounded border-slate-300" data-id="${i.id}"></td>
                    <td class="p-3 uppercase font-medium">${i.name}</td>
                    <td class="p-3 text-center text-xs font-bold">${i.category==='A'?'WAJIB':'PILIHAN'}</td>
                    <td class="p-3 text-center">RM ${i.price.toFixed(2)}</td>
                    <td class="p-3 text-center"><button onclick="window.deleteInventoryItem('${i.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        };

        window.renderAdminPibg = () => {
             const tb = document.getElementById('adm-pibg-body');
             if(!tb) return;
             const pibgItems = [...window.itemsA, ...window.itemsB].filter(i => i.name.toUpperCase().includes('PIBG')).map(i => i.id);
             const list = window.orders.filter(o => o.items && Object.keys(o.items).some(k => pibgItems.includes(k)));
             tb.innerHTML = list.length ? list.map(o => `
                <tr class="border-b hover:bg-yellow-50 text-sm">
                    <td class="p-3 uppercase font-bold">${o.name}</td>
                    <td class="p-3 uppercase text-xs">${o.parent}</td>
                    <td class="p-3 text-center text-green-600 font-bold text-xs"><i class="fas fa-check"></i> YA</td>
                    <td class="p-3 text-center font-mono text-xs">RM ${(o.paid||0).toFixed(2)}</td>
                </tr>
             `).join('') : '<tr><td colspan="4" class="p-6 text-center text-slate-400">Tiada rekod PIBG.</td></tr>';
        };

        window.renderAdminNametags = () => {
             const tb = document.getElementById('adm-tag-body');
             if(!tb) return;
             // FIX: Include itemsA as well and use helper
             const tagItems = [...window.itemsA, ...window.itemsB].filter(i => i.isNametag || window.isNametagItem(i.name)).map(i => i.id);
             const list = window.orders.filter(o => o.items && Object.keys(o.items).some(k => tagItems.includes(k)));
             tb.innerHTML = list.length ? list.map(o => {
                let qty = 0;
                Object.keys(o.items).forEach(k => { if(tagItems.includes(k)) qty += o.items[k]; });
                return `
                <tr class="border-b hover:bg-purple-50 text-sm">
                    <td class="p-3 uppercase font-medium">${o.name}</td>
                    <td class="p-3 font-bold uppercase text-purple-700">${o.tagName||'-'}</td>
                    <td class="p-3 text-center font-bold">${qty}</td> <!-- Added Quantity Cell -->
                    <td class="p-3 text-center"><button onclick="window.updateTagStatus('${o.id}', ${o.tagStatus})" class="px-2 py-1 rounded text-[10px] font-bold text-white ${o.tagStatus?'bg-green-500':'bg-amber-500'}">${o.tagStatus?'SIAP':'PROSES'}</button></td>
                </tr>
             `}).join('') : '<tr><td colspan="4" class="p-6 text-center text-slate-400">Tiada tempahan nametag.</td></tr>';
        };

        window.renderAdminLogs = () => {
            const tb = document.getElementById('adm-log-body');
            if(!tb) return;
            const sorted = [...window.orders].sort((a,b)=> b.timestamp - a.timestamp);
            tb.innerHTML = sorted.map(o => `<tr class="border-b text-xs"><td class="p-3 text-slate-400 font-mono">${new Date(o.timestamp).toLocaleString('ms-MY')}</td><td class="p-3 font-bold text-blue-600">ORDER</td><td class="p-3 uppercase">Tempahan oleh ${o.name} (RM ${o.total.toFixed(2)})</td></tr>`).join('');
        };

        window.renderAdminSettings = () => {
            const toggle = document.getElementById('systemStatusToggle');
            const msgInput = document.getElementById('closedMessageInput');
            if(toggle && msgInput) {
                toggle.checked = window.systemConfig.ordersOpen;
                msgInput.value = window.systemConfig.closedMessage || "";
            }
        };

        // --- SETTINGS LOGIC ---
        window.saveSystemSettings = async () => {
             const isOpen = document.getElementById('systemStatusToggle').checked;
             const msg = document.getElementById('closedMessageInput').value;
             try {
                 await setDoc(configDocRef, { ordersOpen: isOpen, closedMessage: msg }, { merge: true });
                 window.systemConfig = { ordersOpen: isOpen, closedMessage: msg };
                 window.updateSystemUI();
                 alert("Tetapan sistem berjaya disimpan.");
             } catch(e) {
                 alert("Ralat menyimpan tetapan: " + e.message);
             }
        };

        window.updateSystemUI = () => {
            const btn = document.getElementById('btnToggleSystem');
            if(btn) {
                if(window.isSystemOpen) {
                    btn.innerText = "DIBUKA (ON)";
                    btn.className = "px-6 py-2 rounded-lg font-bold text-xs text-white transition shadow-lg bg-green-500 hover:bg-green-600";
                } else {
                    btn.innerText = "DITUTUP (OFF)";
                    btn.className = "px-6 py-2 rounded-lg font-bold text-xs text-white transition shadow-lg bg-red-500 hover:bg-red-600";
                }
            }
            const landingBtn = document.getElementById('landingStartBtn');
            const landingMsg = document.getElementById('landingStatusMsg');
            if(landingBtn) {
                if(window.isSystemOpen) {
                     landingBtn.innerHTML = 'MULA SEKARANG <i class="fas fa-arrow-right ml-2"></i>';
                     landingBtn.classList.remove('btn-disabled');
                     landingBtn.onclick = window.startOrder;
                     if(landingMsg) landingMsg.classList.add('hidden');
                } else {
                     landingBtn.innerHTML = 'TEMPAHAN DITUTUP <i class="fas fa-lock ml-2"></i>';
                     landingBtn.classList.add('btn-disabled');
                     landingBtn.onclick = null;
                     if(landingMsg) landingMsg.classList.remove('hidden');
                }
            }
        };

        window.toggleSystemStatus = async () => {
            const newState = !window.isSystemOpen;
            try {
                await setDoc(configDocRef, { isSystemOpen: newState }, { merge: true });
            } catch(e) { alert("Gagal kemaskini status: " + e.message); }
        };

        // --- BULK & DELETE ACTIONS ---
        window.toggleSelectAll = (source, selector) => document.querySelectorAll(selector).forEach(box => box.checked = source.checked);

        window.deleteSelectedOrders = async () => {
             const cbs = document.querySelectorAll('.order-checkbox:checked');
             if(!cbs.length) return alert("Pilih tempahan dahulu.");
             if(confirm(`Padam ${cbs.length} tempahan?`)) {
                 const batch = writeBatch(db);
                 cbs.forEach(cb => batch.delete(doc(db, 'book_orders', cb.dataset.id)));
                 await batch.commit();
                 document.getElementById('orderSelectAll').checked = false;
             }
        };

        window.deleteSelectedItems = async () => {
             const cbs = document.querySelectorAll('.inv-checkbox:checked');
             if(!cbs.length) return alert("Pilih item dahulu.");
             if(confirm(`Padam ${cbs.length} item?`)) {
                 const batch = writeBatch(db);
                 cbs.forEach(cb => batch.delete(doc(db, 'book_items', cb.dataset.id)));
                 await batch.commit();
                 document.getElementById('invSelectAll').checked = false;
             }
        };

        window.deleteInventoryItem = (id) => {
            if(confirm("Adakah anda pasti ingin memadam item ini dari inventori?\nTindakan ini tidak boleh dikembalikan.")) {
                deleteDoc(doc(db, 'book_items', id)).catch(e => alert("Ralat: " + e.message));
            }
        };

        // --- FIREBASE LISTENERS ---
        const init = async () => {
            try {
                const settingsDoc = await getDoc(configDocRef);
                if (settingsDoc.exists()) {
                    const d = settingsDoc.data();
                    window.systemConfig = d;
                    window.isSystemOpen = d.isSystemOpen !== undefined ? d.isSystemOpen : true;
                }
                window.updateSystemUI();

                onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                         window.isAdminUser = true;
                         if(!document.getElementById('adminLoginModal').classList.contains('hidden')) {
                             window.closeAdminModal();
                             window.switchView('admin');
                         }
                    } else {
                         window.isAdminUser = false;
                    }
                });

                await signInAnonymously(auth).catch(e => console.log("Public mode enabled/Anonymous error handled."));
                
                onSnapshot(query(itemsColl), (snap) => {
                    const all = []; snap.forEach(d => all.push({ id: d.id, ...d.data() }));
                    window.itemsA = all.filter(i => i.category === 'A').sort((a,b)=> (a.order||0)-(b.order||0));
                    window.itemsB = all.filter(i => i.category === 'B').sort((a,b)=> (a.order||0)-(b.order||0));
                    window.renderUserForm(); window.renderAdminInventory();
                });
                onSnapshot(query(ordersColl), (snap) => {
                    window.orders = []; snap.forEach(d => window.orders.push({ id: d.id, ...d.data() }));
                    if(!document.getElementById('admin-view').classList.contains('hidden')) {
                         const currentTab = document.querySelector('.admin-nav-item.bg-slate-800')?.id.replace('nav-', '');
                         if(currentTab) window.setAdminTab(currentTab);
                    }
                });
                onSnapshot(configDocRef, (doc) => {
                    if(doc.exists()) {
                        const d = doc.data();
                        window.systemConfig = d;
                        window.isSystemOpen = d.isSystemOpen !== undefined ? d.isSystemOpen : true;
                        window.updateSystemUI();
                    }
                });
            } catch(e) { console.error("DB Error", e); }
        };
        window.addEventListener('DOMContentLoaded', init);

        // Modals & Helpers
        window.openAdminModal = () => {
            if(window.isAdminUser) window.switchView('admin');
            else document.getElementById('adminLoginModal').classList.remove('hidden');
        };
        
        window.closeAdminModal = () => document.getElementById('adminLoginModal').classList.add('hidden');
        
        window.loginWithEmail = async () => {
             const email = document.getElementById('adminEmailInput').value.trim(); const pass = document.getElementById('adminPasswordInput').value;
             if(!email || !pass) { alert("Sila masukkan email dan kata laluan."); return; }
             try {
                 await signInWithEmailAndPassword(auth, email, pass);
             } catch(e) {
                 document.getElementById('loginError').classList.remove('hidden');
             }
        };

        window.togglePasswordVisibility = () => {
            const passwordInput = document.getElementById('adminPasswordInput');
            const eyeIcon = document.getElementById('eyeIcon');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        };
        
        window.logoutAdmin = async () => {
             await signOut(auth);
             window.goHome();
        };

        window.openAddItemModal = () => document.getElementById('addItemModal').classList.remove('hidden');
        window.closeAddItemModal = () => document.getElementById('addItemModal').classList.add('hidden');
        window.saveNewItem = async () => {
             const name = document.getElementById('newItemName').value;
             const price = parseFloat(document.getElementById('newItemPrice').value);
             const category = document.getElementById('newItemCategory').value;
             const isNametag = document.getElementById('newItemNametag').checked;
             if(!name || isNaN(price)) return alert("Isi semua data.");
             await addDoc(itemsColl, { name, price, category, isNametag, order: Date.now() });
             window.closeAddItemModal();
             document.getElementById('newItemName').value = '';
             document.getElementById('newItemPrice').value = '';
        };

        window.openPaymentModal = (id, cur, tot) => {
            window.selectedOrderIdForPayment = id;
            document.getElementById('paymentModalTotal').innerText = `RM ${tot.toFixed(2)}`;
            document.getElementById('paymentInput').value = cur;
            document.getElementById('paymentModal').classList.remove('hidden');
        };
        window.closePaymentModal = () => document.getElementById('paymentModal').classList.add('hidden');
        window.savePayment = async () => {
            const val = parseFloat(document.getElementById('paymentInput').value);
            if(window.selectedOrderIdForPayment && !isNaN(val)) {
                await updateDoc(doc(db, 'book_orders', window.selectedOrderIdForPayment), { paid: val });
                window.closePaymentModal();
            }
        };
        window.updateTagStatus = async (id, cur) => await updateDoc(doc(db, 'book_orders', id), { tagStatus: !cur });
    </script>
</head>
<body class="bg-slate-50 flex flex-col min-h-screen text-slate-800">

    <!-- NAVBAR (Public) -->
    <nav id="mainNavbar" class="bg-white/90 backdrop-blur-md sticky top-0 z-40 px-6 py-4 shadow-sm border-b border-slate-100 transition-all no-print">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.goHome()">
                <div class="bg-brand-600 text-white p-2 rounded-lg shadow-lg shadow-brand-200"><img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" class="w-8 h-8 object-contain"/></div>
                <div><h1 class="text-lg font-black tracking-tight text-slate-800 leading-none">PRASEKOLAH LAVENDER</h1><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Sistem Pengurusan Yuran</p></div>
            </div>
            <button onclick="window.openAdminModal()" class="text-slate-400 hover:text-brand-600 font-bold text-xs uppercase tracking-wider flex items-center gap-2 transition px-3 py-2 hover:bg-slate-50 rounded-lg"><i class="fas fa-lock"></i> Admin</button>
        </div>
    </nav>

    <!-- LANDING VIEW -->
    <div id="landing-view" class="flex-grow flex items-center justify-center p-6 animate-fadeUp">
        <div class="w-full max-w-4xl grid md:grid-cols-2 gap-6">
            <div onclick="window.startOrder()" class="bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all cursor-pointer border-2 border-transparent hover:border-brand-500 group relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-brand-50 w-32 h-32 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-110 transition-transform"></div>
                <div class="w-16 h-16 bg-brand-100 text-brand-600 rounded-2xl flex items-center justify-center text-3xl mb-6 relative z-10 shadow-sm"><i class="fas fa-cart-plus"></i></div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2 relative z-10">Buat Tempahan Baru</h2>
                <p class="text-slate-500 text-sm mb-8 relative z-10">Daftar item keperluan persekolahan dan jana invois.</p>
                <div class="mt-4 relative z-10">
                    <p id="landingStatusMsg" class="hidden text-red-500 text-xs font-bold mb-2 bg-red-50 p-2 rounded">Maaf, sistem tempahan ditutup buat sementara waktu.</p>
                    <button id="landingStartBtn" class="text-brand-600 font-bold text-sm flex items-center group-hover:gap-2 transition-all">MULA SEKARANG <i class="fas fa-arrow-right ml-2"></i></button>
                </div>
            </div>
            <div onclick="window.startCheck()" class="bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all cursor-pointer border-2 border-transparent hover:border-blue-500 group relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-blue-50 w-32 h-32 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-110 transition-transform"></div>
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-3xl mb-6 relative z-10 shadow-sm"><i class="fas fa-magnifying-glass-dollar"></i></div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2 relative z-10">Semakan Status</h2>
                <p class="text-slate-500 text-sm mb-8 relative z-10">Semak status bayaran, kemaskini tempahan dan cetak semula resit.</p>
                <span class="text-blue-600 font-bold text-sm flex items-center group-hover:gap-2 transition-all">SEMAK REKOD <i class="fas fa-arrow-right ml-2"></i></span>
            </div>
        </div>
    </div>

    <!-- CHECK STATUS VIEW -->
    <div id="check-view" class="hidden container mx-auto px-4 py-8 max-w-lg flex-grow">
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
            <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Semakan Rekod</h2>
            <div class="relative mb-6"><i class="fas fa-phone absolute left-4 top-3.5 text-slate-400"></i><input type="tel" id="checkPhone" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold text-slate-700" placeholder="Masukkan No. Telefon"></div>
            <button onclick="window.doCheckStatus()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95">SEMAK</button>
        </div>
        <div id="checkResults" class="mt-8"></div>
        <div class="text-center mt-8"><button onclick="window.goHome()" class="text-slate-400 font-bold text-xs uppercase tracking-widest"><i class="fas fa-arrow-left mr-2"></i> Kembali</button></div>
    </div>

    <!-- USER ORDER FLOW -->
    <main id="user-view" class="hidden flex-grow flex flex-col pb-28">
        <div class="bg-white border-b border-slate-100 py-6 sticky top-0 z-30 shadow-sm no-print">
            <div class="container mx-auto max-w-2xl px-6 relative">
                <div class="absolute top-3 left-6 right-6 h-1 bg-slate-100 rounded-full -z-10"></div>
                <div id="progress-bar-fill" class="absolute top-3 left-6 h-1 bg-brand-500 rounded-full -z-10 transition-all duration-500 ease-out" style="width: 0%"></div>
                <div class="flex justify-between w-full">
                    <div id="step-info" class="flex flex-col items-center cursor-pointer" onclick="window.safeNavigate('section-info')"><div class="step-circle w-7 h-7 rounded-full bg-brand-600 text-white border-4 border-white shadow-sm flex items-center justify-center font-bold text-[10px] transition-all">1</div><span class="step-label text-[10px] font-bold mt-2 text-brand-700 uppercase">Profil</span></div>
                    <div id="step-a" class="flex flex-col items-center"><div class="step-circle w-7 h-7 rounded-full bg-white text-slate-300 border-4 border-white flex items-center justify-center font-bold text-[10px] transition-all border border-slate-200">2</div><span class="step-label text-[10px] font-bold mt-2 text-slate-400 uppercase">Wajib</span></div>
                    <div id="step-b" class="flex flex-col items-center"><div class="step-circle w-7 h-7 rounded-full bg-white text-slate-300 border-4 border-white flex items-center justify-center font-bold text-[10px] transition-all border border-slate-200">3</div><span class="step-label text-[10px] font-bold mt-2 text-slate-400 uppercase">Pilihan</span></div>
                    <div id="step-d" class="flex flex-col items-center"><div class="step-circle w-7 h-7 rounded-full bg-white text-slate-300 border-4 border-white flex items-center justify-center font-bold text-[10px] transition-all border border-slate-200">4</div><span class="step-label text-[10px] font-bold mt-2 text-slate-400 uppercase">Sah</span></div>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8 max-w-2xl no-print">
            <div id="section-info" class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 animate-fadeUp">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Maklumat Murid</h2>
                <div class="space-y-5">
                    <div><label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">Nama Penuh Murid</label><input type="text" id="studentName" class="w-full pl-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none uppercase font-bold text-slate-700 text-sm" placeholder="CTH: AHMAD BIN ALI"></div>
                    <div class="grid md:grid-cols-2 gap-5">
                        <div><label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">Nama Penjaga</label><input type="text" id="parentName" class="w-full pl-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none uppercase font-medium text-slate-700 text-sm"></div>
                        <div><label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1.5 block">No. Telefon</label><input type="tel" id="parentPhone" class="w-full pl-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700 text-sm"></div>
                    </div>
                </div>
                <button onclick="window.nextSection('section-a')" class="w-full mt-8 bg-brand-600 hover:bg-brand-700 text-white font-bold py-4 rounded-xl shadow-xl transition">TERUSKAN</button>
                <button onclick="window.goHome()" class="w-full mt-4 text-slate-400 text-xs font-bold uppercase tracking-widest hover:text-slate-600">Batal</button>
            </div>

            <div id="section-a" class="hidden bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden animate-fadeUp">
                <div class="bg-white p-6 border-b flex justify-between items-center sticky top-0 z-20"><h3 class="font-bold text-lg text-slate-800">Item Wajib (A)</h3><span class="text-[10px] bg-brand-50 text-brand-700 px-3 py-1 rounded-full font-bold border border-brand-100">WAJIB</span></div>
                <div class="p-0 overflow-x-auto"><table class="w-full text-left"><tbody id="tbody-a" class="divide-y divide-slate-50"></tbody></table></div>
                <div class="p-5 bg-slate-50 border-t flex justify-between items-center">
                    <div class="text-right flex-grow mr-4"><span class="text-[10px] block text-slate-400 font-bold uppercase">Subjumlah</span><span class="text-xl font-black text-brand-700">RM <span id="totalA">0.00</span></span></div>
                    <button onclick="window.safeNavigate('section-b')" class="bg-slate-900 text-white px-6 py-2.5 rounded-lg font-bold text-sm shadow-lg">Seterusnya</button>
                </div>
            </div>

            <div id="section-b" class="hidden bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden animate-fadeUp">
                <div class="bg-white p-6 border-b sticky top-0 z-20"><h3 class="font-bold text-lg text-slate-800">Item Pilihan (B)</h3></div>
                <div class="p-0 overflow-x-auto"><table class="w-full text-left"><tbody id="tbody-b" class="divide-y divide-slate-50"></tbody></table></div>
                <div class="p-5 bg-slate-50 border-t flex justify-between items-center">
                    <button onclick="window.safeNavigate('section-a')" class="text-slate-400 font-bold text-xs px-2">KEMBALI</button>
                    <button onclick="window.safeNavigate('section-d')" class="bg-brand-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg">SEMAK & SAHKAN</button>
                </div>
            </div>

            <div id="section-d" class="hidden bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden animate-fadeUp relative">
                <div class="p-8 pb-0 text-center">
                    <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Anggaran Keseluruhan</p>
                    <h2 class="text-5xl font-black text-slate-800" id="grandTotalDisplay">RM 0.00</h2>
                </div>
                <div class="p-8">
                    <div class="bg-slate-50 rounded-xl border border-slate-100 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 text-[10px] uppercase text-slate-500 font-bold"><tr><th class="py-3 px-4">Butiran</th><th class="py-3 px-4 text-center w-16">Unit</th><th class="py-3 px-4 text-right w-24">Harga</th></tr></thead>
                            <tbody id="summary-tbody" class="divide-y divide-slate-100 text-sm"></tbody>
                        </table>
                    </div>
                </div>
                <div class="p-6 bg-slate-50 border-t flex justify-between items-center gap-4">
                    <button onclick="window.safeNavigate('section-b')" class="text-slate-400 font-bold text-xs order-2 md:order-1">UBAH PESANAN</button>
                    <button onclick="window.submitOrder()" id="submitOrderBtn" class="w-full md:w-auto order-1 md:order-2 bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-3.5 rounded-xl font-bold shadow-xl flex items-center justify-center transition">
                        <i class="fas fa-check-circle mr-2"></i> SAHKAN PESANAN
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- ADMIN VIEW -->
    <div id="admin-view" class="hidden fixed inset-0 bg-slate-50 z-50 flex h-screen overflow-hidden no-print">
        <aside class="w-64 bg-slate-900 text-white flex flex-col shrink-0 shadow-2xl relative z-10">
            <div class="p-6 border-b border-slate-800 flex items-center gap-3"><div class="w-8 h-8 rounded bg-brand-500 flex items-center justify-center font-bold text-lg">A</div><div><h2 class="font-bold text-sm tracking-wide">ADMIN PANEL</h2><p class="text-[10px] text-slate-500">Prasekolah Lavender</p></div></div>
            <nav class="flex-grow p-4 space-y-1 overflow-y-auto custom-scrollbar">
                <button onclick="window.setAdminTab('dash')" id="nav-dash" class="admin-nav-item w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition flex items-center"><i class="fas fa-chart-pie w-6 opacity-70"></i> Dashboard</button>
                <button onclick="window.setAdminTab('orders')" id="nav-orders" class="admin-nav-item w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition flex items-center"><i class="fas fa-file-invoice w-6 opacity-70"></i> Tempahan</button>
                <button onclick="window.setAdminTab('inventory')" id="nav-inventory" class="admin-nav-item w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition flex items-center"><i class="fas fa-boxes w-6 opacity-70"></i> Inventori</button>
                <div class="pt-6 pb-2 pl-4 text-[10px] font-bold text-slate-600 uppercase tracking-widest">Laporan</div>
                <button onclick="window.setAdminTab('pibg')" id="nav-pibg" class="admin-nav-item w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition flex items-center"><i class="fas fa-hand-holding-heart w-6 opacity-70"></i> Yuran PIBG</button>
                <button onclick="window.setAdminTab('nametag')" id="nav-nametag" class="admin-nav-item w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition flex items-center"><i class="fas fa-id-badge w-6 opacity-70"></i> Nametag</button>
                <button onclick="window.setAdminTab('log')" id="nav-log" class="admin-nav-item w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition flex items-center"><i class="fas fa-history w-6 opacity-70"></i> Log Aktiviti</button>
                <button onclick="window.setAdminTab('settings')" id="nav-settings" class="admin-nav-item w-full text-left px-4 py-3 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition flex items-center"><i class="fas fa-cog w-6 opacity-70"></i> Tetapan</button>
            </nav>
            <div class="p-4 border-t border-slate-800 bg-slate-900"><button onclick="window.logoutAdmin()" class="w-full border border-red-900/50 text-red-500 py-2.5 rounded-lg text-xs font-bold hover:bg-red-950 transition">KELUAR</button></div>
        </aside>

        <main class="flex-grow overflow-y-auto p-8 custom-scrollbar bg-slate-50/50 relative">
            <div id="adm-dash" class="admin-tab animate-fadeUp">
                <div class="flex justify-between items-end mb-8"><div><h2 class="text-3xl font-black text-slate-800 tracking-tight">Dashboard</h2><p class="text-slate-500 text-sm">Ringkasan prestasi.</p></div></div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Jumlah Kutipan</p><h3 class="text-2xl font-black text-emerald-600" id="d-revenue">RM 0.00</h3></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Bil. Murid</p><h3 class="text-2xl font-black text-slate-700" id="d-count">0</h3></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Tunggakan</p><h3 class="text-2xl font-black text-red-500" id="d-pending">RM 0.00</h3></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Nametag</p><h3 class="text-2xl font-black text-brand-600" id="d-tags">0</h3></div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 w-full md:w-1/2"><h4 class="font-bold text-slate-800 mb-6 flex items-center text-sm uppercase tracking-wide">Status Bayaran</h4><div class="h-64 relative"><canvas id="chartPayment"></canvas></div></div>
            </div>
            <div id="adm-orders" class="hidden admin-tab animate-fadeUp">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-slate-800">Senarai Tempahan</h2><button onclick="window.deleteSelectedOrders()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg">HAPUS DIPILIH</button></div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase font-bold"><tr><th class="p-4 w-10 text-center"><input type="checkbox" id="orderSelectAll" onchange="window.toggleSelectAll(this, '.order-checkbox')" class="rounded"></th><th class="p-4">Maklumat</th><th class="p-4 text-center">Jumlah</th><th class="p-4 text-center">Dibayar</th><th class="p-4 text-center">Tindakan</th></tr></thead><tbody id="adm-orders-body" class="divide-y divide-slate-100"></tbody></table></div>
            </div>
            <div id="adm-inventory" class="hidden admin-tab animate-fadeUp">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-slate-800">Inventori</h2><div class="flex gap-2"><button onclick="window.deleteSelectedItems()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold">HAPUS</button><button onclick="window.openAddItemModal()" class="bg-brand-600 text-white px-4 py-2 rounded-lg font-bold text-xs">+ TAMBAH</button></div></div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase font-bold"><tr><th class="p-4 w-10 text-center"><input type="checkbox" id="invSelectAll" onchange="window.toggleSelectAll(this, '.inv-checkbox')" class="rounded"></th><th class="p-4">Item</th><th class="p-4 text-center">Kategori</th><th class="p-4 text-center">Harga</th><th class="p-4 text-center">Aksi</th></tr></thead><tbody id="adm-inv-body" class="divide-y divide-slate-100"></tbody></table></div>
            </div>
            <div id="adm-pibg" class="hidden admin-tab animate-fadeUp">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Yuran PIBG</h2>
                    <div class="flex gap-2">
                        <button onclick="window.exportPibgCsv()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-green-700">Excel</button>
                        <button onclick="window.exportPibgPdf()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-red-700">PDF</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-yellow-100 text-yellow-900 border-b border-yellow-200 font-bold text-xs uppercase"><tr><th class="p-4">Nama Murid</th><th class="p-4">Nama Penjaga</th><th class="p-4 text-center">Bayaran (RM)</th><th class="p-4 text-center">Status Bayaran</th></tr></thead><tbody id="adm-pibg-body" class="divide-y divide-slate-100"></tbody></table></div>
            </div>
            <div id="adm-nametag" class="hidden admin-tab animate-fadeUp">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Tempahan Nametag</h2>
                     <div class="flex gap-2">
                        <button onclick="window.exportNametagCsv()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-green-700">Excel</button>
                        <button onclick="window.exportNametagPdf()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-red-700">PDF</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-purple-50 text-purple-900 border-b border-purple-100 font-bold text-xs uppercase"><tr><th class="p-4">Nama Murid</th><th class="p-4">Teks Pada Tag</th><th class="p-4 text-center">Kuantiti</th><th class="p-4 text-center">Status</th></tr></thead><tbody id="adm-tag-body" class="divide-y divide-slate-100"></tbody></table></div>
            </div>
            <div id="adm-log" class="hidden admin-tab animate-fadeUp">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Log Aktiviti</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b border-slate-200 font-bold text-xs uppercase text-slate-500"><tr><th class="p-4 w-40">Masa</th><th class="p-4 w-32">Aksi</th><th class="p-4">Perincian</th></tr></thead><tbody id="adm-log-body" class="divide-y divide-slate-100"></tbody></table></div>
            </div>
            
            <div id="adm-settings" class="hidden admin-tab animate-fadeUp">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Tetapan Sistem</h2>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 max-w-lg">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Status Tempahan</h3>
                    <div class="flex items-center justify-between bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <div>
                            <p class="text-sm font-bold text-slate-700">Kawal Penerimaan Tempahan</p>
                            <p class="text-xs text-slate-500 mt-1">Tutup sistem apabila kuota penuh atau tarikh tutup.</p>
                        </div>
                        <button id="btnToggleSystem" onclick="window.toggleSystemStatus()" class="px-6 py-2 rounded-lg font-bold text-xs text-white transition shadow-lg bg-green-500">MEMUATKAN...</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="adminLoginModal" class="fixed inset-0 bg-slate-900/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center">
            <div class="mb-4 flex justify-center"><img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" class="h-16 w-auto"></div>
            <h3 class="text-xl font-bold text-slate-800 mb-4">Akses Pentadbir</h3>
            <div class="space-y-3 text-left">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Email</label>
                    <input type="email" id="adminEmailInput" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none focus:border-brand-500 text-sm" placeholder="admin@sekolah.com">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Kata Laluan</label>
                    <div class="relative">
                        <input type="password" id="adminPasswordInput" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl outline-none focus:border-brand-500 text-sm pr-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <button onclick="window.togglePasswordVisibility()" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-400 hover:text-brand-600 focus:outline-none">
                            <i id="eyeIcon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="loginError" class="hidden text-red-500 text-xs font-bold mt-3">Email atau kata laluan salah!</div>
            <button onclick="window.loginWithEmail()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl mt-6 shadow-lg transition">LOG MASUK</button>
            <button onclick="window.closeAdminModal()" class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-4 hover:text-slate-600">Batal</button>
        </div>
    </div>
    <div id="addItemModal" class="fixed inset-0 bg-slate-900/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Tambah Item</h3>
            <div class="space-y-4 mb-6">
                <input type="text" id="newItemName" class="w-full border p-3 rounded-lg outline-none uppercase font-bold text-sm" placeholder="NAMA ITEM">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" step="0.01" id="newItemPrice" class="w-full border p-3 rounded-lg outline-none text-sm" placeholder="HARGA RM">
                    <select id="newItemCategory" class="w-full border p-3 rounded-lg outline-none text-sm"><option value="B">Pilihan (B)</option><option value="A">Wajib (A)</option></select>
                </div>
                <label class="flex items-center text-xs font-bold cursor-pointer"><input type="checkbox" id="newItemNametag" class="mr-2"> Perlu Nametag?</label>
            </div>
            <div class="flex gap-2">
                <button onclick="window.closeAddItemModal()" class="flex-1 border py-3 rounded-xl font-bold text-xs">BATAL</button>
                <button id="btnSaveItem" onclick="window.saveNewItem()" class="flex-1 bg-brand-600 text-white py-3 rounded-xl font-bold text-xs">SIMPAN</button>
            </div>
        </div>
    </div>
    <div id="paymentModal" class="fixed inset-0 bg-slate-900/60 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Kemaskini Bayaran</h3>
            <p class="text-slate-400 text-xs mb-6">Jumlah Perlu Dibayar: <span id="paymentModalTotal" class="font-bold text-slate-800"></span></p>
            <div class="mb-6"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Jumlah Telah Dibayar (RM)</label><input type="number" step="0.01" id="paymentInput" class="w-full bg-slate-50 border-2 border-brand-100 p-4 rounded-xl outline-none focus:border-brand-500 text-center text-2xl font-bold text-brand-700"></div>
            <div class="flex gap-3"><button onclick="window.closePaymentModal()" class="flex-1 py-3 rounded-xl font-bold text-xs border border-slate-200 hover:bg-slate-50">BATAL</button><button onclick="window.savePayment()" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white py-3 rounded-xl font-bold text-xs shadow-lg">KEMASKINI</button></div>
        </div>
    </div>
    <!-- RECEIPT VIEW -->
    <div id="receiptView" class="hidden fixed inset-0 bg-white z-[90] p-4 md:p-8 overflow-y-auto custom-scrollbar">
        <div class="max-w-2xl mx-auto mb-6 no-print flex justify-between items-center bg-slate-900 text-white p-4 rounded-xl shadow-2xl">
            <button onclick="window.closeReceipt()" class="text-slate-400 hover:text-white font-bold flex items-center text-sm px-2"><i class="fas fa-arrow-left mr-2"></i> TUTUP</button>
            <button onclick="window.printReceipt()" class="bg-white text-slate-900 px-5 py-2 rounded-lg font-bold text-sm shadow hover:bg-slate-100 transition"><i class="fas fa-print mr-2"></i> CETAK / PDF</button>
        </div>
        <div class="max-w-2xl mx-auto border border-slate-200 shadow-xl p-8 md:p-12 bg-white relative print:shadow-none print:border-0" id="receiptContent">
            <div class="text-center mb-10 border-b-2 border-slate-800 pb-6">
                <h2 class="text-3xl font-black tracking-tighter uppercase text-slate-900">SK Masjid Tanah</h2>
                <p class="text-xs font-bold text-slate-500 uppercase tracking-[0.3em] mt-1">Prasekolah Lavender 2026</p>
            </div>
            <div class="flex justify-between items-end mb-8">
                <div><h3 class="text-4xl font-black text-brand-600 uppercase tracking-tighter" id="doc-title">INVOIS</h3><p class="text-xs text-slate-400 font-mono mt-1">ID: <span id="r-id" class="text-slate-800 font-bold"></span></p></div>
                <div class="text-right"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tarikh</p><p class="font-bold text-slate-800" id="r-date"></p></div>
            </div>
            <div class="bg-slate-50 p-6 rounded-lg mb-8 border border-slate-100 grid grid-cols-2 gap-6 uppercase">
                <div><p class="text-[10px] font-bold text-slate-400 mb-1">Nama Murid</p><p class="font-bold text-lg text-slate-800 leading-tight" id="r-name"></p></div>
                <div><p class="text-[10px] font-bold text-slate-400 mb-1">Nama Penjaga</p><p class="font-medium text-slate-700" id="r-parent"></p></div>
            </div>
            <table class="w-full text-sm mb-10">
                <thead><tr class="border-b-2 border-slate-800 text-xs font-bold uppercase text-slate-600"><th class="py-3 text-left">Perincian</th><th class="py-3 text-center w-24">Harga</th><th class="py-3 text-center w-16">Unit</th><th class="py-3 text-right w-24">Jum</th></tr></thead>
                <tbody id="r-body" class="divide-y divide-slate-100"></tbody>
            </table>
            <div class="flex justify-end">
                <div class="w-1/2">
                    <div class="flex justify-between py-2 border-b border-slate-100"><span class="font-bold text-slate-500 text-xs uppercase">Jumlah Besar</span><span class="font-bold text-slate-800" id="r-total">RM 0.00</span></div>
                    <div class="flex justify-between py-2 border-b border-slate-100"><span class="font-bold text-slate-500 text-xs uppercase">Telah Dibayar</span><span class="font-bold text-emerald-600" id="r-paid">RM 0.00</span></div>
                    <div class="flex justify-between py-4"><span class="font-black text-slate-800 text-sm uppercase" id="r-balance-label">Baki</span><span class="font-black text-2xl text-red-600" id="r-balance">RM 0.00</span></div>
                </div>
            </div>
        </div>
    </div>
    <div id="mobileActionBar" class="hidden md:hidden fixed bottom-0 left-0 w-full bg-white border-t p-4 z-40 flex justify-between items-center shadow-lg no-print">
        <div class="flex flex-col"><span class="text-[10px] font-bold uppercase text-slate-400">Anggaran</span><div class="text-xl font-black text-brand-700" id="mobileGrandTotal">RM 0.00</div></div>
        <button onclick="window.safeNavigate('section-d')" class="bg-brand-600 text-white px-6 py-2 rounded-lg font-bold text-xs shadow-lg">SEMAK</button>
    </div>
</body>
</html>
